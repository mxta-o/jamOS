{% extends "base.html" %}

{% block title %}Time Block Calendar - jamOS{% endblock %}

{% block extra_css %}
<style>
    /* Force grid layout - override any base styles */
    .calendar-header,
    div.calendar-header {
        background: linear-gradient(135deg, #7B9FBE 0%, #5A7FA0 100%) !important;
        color: white !important;
        padding: 0.5rem !important;
        display: grid !important;
        grid-template-columns: repeat(7, 1fr) !important;
        gap: 2px !important;
    }
    
    .calendar-days,
    div.calendar-days {
        display: grid !important;
        grid-template-columns: repeat(7, 1fr) !important;
        gap: 2px !important;
        background: #1a2332 !important;
        padding: 2px !important;
    }
    
    .planner-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        background: transparent;
    }
    
    .planner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .view-toggle {
        display: flex;
        gap: 0.5rem;
        background: #2c4662;
        padding: 0.5rem;
        border-radius: 12px;
    }
    
    .view-btn {
        padding: 0.6rem 1.5rem;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: #b8d4e8;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .view-btn:hover {
        background: rgba(123, 159, 190, 0.2);
        color: #e8f4f8;
    }
    
    .view-btn.active {
        background: linear-gradient(135deg, #7B9FBE 0%, #5A7FA0 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .date-navigation {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: #3d5a80;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .date-nav-btn {
        background: #7B9FBE;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }
    
    .date-nav-btn:hover {
        background: #5A7FA0;
    }
    
    .current-date {
        font-size: 1.2rem;
        font-weight: bold;
        color: #e8f4f8;
        min-width: 250px;
        text-align: center;
    }
    
    /* Monthly Calendar Styles */
    .calendar-container {
        background: #2c3e50;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    
    /* Weekly View Styles */
    .weekly-container {
        display: none;
        background: #2c3e50;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    
    .weekly-container.active {
        display: block;
    }
    
    .weekly-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1rem;
        padding: 1rem;
    }
    
    .day-column {
        background: #2c4662;
        border-radius: 15px;
        padding: 1rem;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    
    .weekly-day-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
        color: white;
        padding: 0.8rem;
        text-align: center;
        font-weight: bold;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .weekly-day-header.today {
        background: linear-gradient(135deg, #5a7fa0 0%, #4a6fa5 100%);
        box-shadow: 0 0 0 2px #ffd700;
    }
    
    .day-column-blocks {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        flex: 1;
    }
    
    .empty-day-message {
        color: #7B9FBE;
        text-align: center;
        padding: 2rem 1rem;
        font-size: 0.9rem;
        opacity: 0.6;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .empty-day-message:hover {
        opacity: 1;
        color: #e8f4f8;
    }
    
    .add-block-btn {
        background: linear-gradient(135deg, #7B9FBE 0%, #5A7FA0 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }
    
    .add-block-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(123, 159, 190, 0.4);
    }
    
    .day-column.drag-over {
        background: #3d5a80;
        border: 2px dashed #7B9FBE;
    }
    
    .calendar-block.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }
    
    .weekly-container .calendar-block {
        margin: 0;
        cursor: grab;
        user-select: none;
    }
    
    .weekly-container .calendar-block:active {
        cursor: grabbing;
    }
    
    .weekly-stats-panel {
        background: #2c4662;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .category-breakdown {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    
    .category-stat {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 0;
        border-bottom: 1px solid rgba(123, 159, 190, 0.2);
    }
    
    .category-stat:last-child {
        border-bottom: none;
    }
    
    .category-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        flex: 1;
    }
    
    .category-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }
    
    .category-color.work { background: #7B9FBE; }
    .category-color.personal { background: #11998e; }
    .category-color.health { background: #ff6b6b; }
    .category-color.learning { background: #a8e6cf; }
    .category-color.social { background: #ffd89b; }
    
    .category-name {
        color: #e8f4f8;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .category-time {
        color: #7B9FBE;
        font-weight: bold;
        font-size: 0.95rem;
        min-width: 60px;
        text-align: right;
    }
    
    .category-bar {
        flex: 1;
        height: 6px;
        background: rgba(0,0,0,0.2);
        border-radius: 3px;
        overflow: hidden;
        margin-left: 1rem;
    }
    
    .category-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .category-bar-fill.work { background: linear-gradient(90deg, #7B9FBE 0%, #9ec5e8 100%); }
    .category-bar-fill.personal { background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); }
    .category-bar-fill.health { background: linear-gradient(90deg, #ff6b6b 0%, #ffa726 100%); }
    .category-bar-fill.learning { background: linear-gradient(90deg, #a8e6cf 0%, #88d8c0 100%); }
    .category-bar-fill.social { background: linear-gradient(90deg, #ffd89b 0%, #19547b 100%); }
    
    .today-panel {
        background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
        border-radius: 15px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .today-panel h4 {
        margin: 0;
        color: #e8f4f8;
        font-size: 1.1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(123, 159, 190, 0.3);
    }
    
    .today-total {
        color: #7B9FBE;
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }
    
    .today-blocks-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .today-block-item {
        background: rgba(0,0,0,0.2);
        padding: 0.6rem;
        border-radius: 8px;
        border-left: 3px solid;
        font-size: 0.85rem;
        color: #e8f4f8;
    }
    
    .today-block-item.work { border-left-color: #7B9FBE; }
    .today-block-item.personal { border-left-color: #11998e; }
    .today-block-item.health { border-left-color: #ff6b6b; }
    .today-block-item.learning { border-left-color: #a8e6cf; }
    .today-block-item.social { border-left-color: #ffd89b; }
    
    .today-empty {
        color: #7B9FBE;
        text-align: center;
        padding: 2rem 1rem;
        font-size: 0.9rem;
        opacity: 0.6;
    }
    
    .stats-header {
        color: #e8f4f8;
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(123, 159, 190, 0.3);
    }
    
    .weekly-container .calendar-block {
        margin: 0;
        cursor: pointer;
    }
    
    .calendar-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
        color: white;
        padding: 0.5rem;
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    
    .day-header {
        text-align: center !important;
        font-weight: bold !important;
        padding: 1rem !important;
        font-size: 1rem !important;
    }
    
    .day-cell,
    div.day-cell {
        background: #3d5a80 !important;
        min-height: 120px !important;
        padding: 0.5rem !important;
        position: relative !important;
        cursor: pointer !important;
        transition: background 0.2s ease !important;
        border: 1px solid #2c4662 !important;
    }
    
    .day-cell:hover {
        background: #4a6fa5 !important;
    }
    
    .day-cell.other-month {
        background: #2a3f5f !important;
        opacity: 0.5;
    }
    
    .day-cell.today {
        background: #5a7fa0 !important;
        border: 2px solid #ffd700 !important;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    
    .day-cell.selected {
        background: #4a6fa5 !important;
        border: 2px solid #7B9FBE !important;
        box-shadow: 0 0 10px rgba(123, 159, 190, 0.4);
    }
    
    .day-number {
        font-weight: bold;
        font-size: 0.9rem;
        color: #e8f4f8;
        margin-bottom: 0.5rem;
    }
    
    .day-blocks {
        flex: 1;
        overflow-y: auto;
    }
    
    .calendar-block {
        background: linear-gradient(135deg, rgba(123, 159, 190, 0.95) 0%, rgba(90, 127, 160, 0.95) 100%);
        color: white;
        padding: 0.5rem;
        border-radius: 8px;
        margin-bottom: 0.4rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        border-left: 3px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }
    
    .calendar-block:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 15px rgba(123, 159, 190, 0.3);
        background: linear-gradient(135deg, rgba(123, 159, 190, 1) 0%, rgba(90, 127, 160, 1) 100%);
    }
    
    .block-time {
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 0.2rem;
        text-transform: uppercase;
    }
    
    .block-title-text {
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1.2;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .block-recurring-icon {
        position: absolute;
        top: 0.3rem;
        right: 0.3rem;
        font-size: 0.7rem;
        opacity: 0.8;
    }
    

    
    .calendar-block.category-work { 
        background: linear-gradient(135deg, rgba(123, 159, 190, 0.95) 0%, rgba(90, 127, 160, 0.95) 100%); 
        border-left-color: #9ec5e8;
    }
    .calendar-block.category-work:hover { 
        background: linear-gradient(135deg, rgba(123, 159, 190, 1) 0%, rgba(90, 127, 160, 1) 100%); 
    }
    
    .calendar-block.category-personal { 
        background: linear-gradient(135deg, rgba(17, 153, 142, 0.95) 0%, rgba(56, 239, 125, 0.95) 100%); 
        border-left-color: #56f39a;
    }
    .calendar-block.category-personal:hover { 
        background: linear-gradient(135deg, rgba(17, 153, 142, 1) 0%, rgba(56, 239, 125, 1) 100%); 
    }
    
    .calendar-block.category-health { 
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.95) 0%, rgba(255, 167, 38, 0.95) 100%); 
        border-left-color: #ffb84d;
    }
    .calendar-block.category-health:hover { 
        background: linear-gradient(135deg, rgba(255, 107, 107, 1) 0%, rgba(255, 167, 38, 1) 100%); 
    }
    
    .calendar-block.category-learning { 
        background: linear-gradient(135deg, rgba(168, 230, 207, 0.95) 0%, rgba(136, 216, 192, 0.95) 100%); 
        border-left-color: #b8f5d9;
    }
    .calendar-block.category-learning:hover { 
        background: linear-gradient(135deg, rgba(168, 230, 207, 1) 0%, rgba(136, 216, 192, 1) 100%); 
    }
    
    .calendar-block.category-social { 
        background: linear-gradient(135deg, rgba(255, 216, 155, 0.95) 0%, rgba(25, 84, 123, 0.95) 100%); 
        border-left-color: #ffe4a8;
    }
    .calendar-block.category-social:hover { 
        background: linear-gradient(135deg, rgba(255, 216, 155, 1) 0%, rgba(25, 84, 123, 1) 100%); 
    }
    
    .quick-actions {
        display: flex;
        gap: 1rem;
    }
    
    .btn-action {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #7B9FBE 0%, #5A7FA0 100%);
        color: white;
    }
    
    .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 2px solid #e1e1e1;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
    }
    
    /* Sidebar Styles */
    .planner-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .planner-grid.monthly-view {
        grid-template-columns: 1fr 400px;
    }
    
    .sidebar-container {
        background: #3d5a80;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        padding: 2rem;
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        display: none;
    }
    
    .planner-grid.monthly-view .sidebar-container {
        display: block;
    }
    
    .sidebar-title {
        font-size: 1.3rem;
        font-weight: bold;
        color: #e8f4f8;
        margin: 0 0 1.5rem 0;
    }
    
    .recurring-toggle {
        margin-top: 1rem;
        padding: 0.8rem;
        background: #2c4662;
        border-radius: 10px;
    }
    
    .recurring-toggle label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        color: #e8f4f8;
    }
    
    .recurring-toggle input[type="checkbox"] {
        width: auto;
        margin: 0;
    }
    
    .recurring-options {
        margin-top: 1rem;
        padding: 1rem;
        background: #2c4662;
        border: 2px solid #4a6fa5;
        border-radius: 10px;
    }
    
    .days-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .day-btn {
        padding: 0.5rem;
        border: 2px solid #4a6fa5;
        background: #3d5a80;
        color: #e8f4f8;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .day-btn.selected {
        background: #7B9FBE;
        color: white;
        border-color: #7B9FBE;
    }
    
    .day-btn:hover {
        border-color: #7B9FBE;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #e8f4f8;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        background: #2c4662;
        color: #e8f4f8;
        border: 2px solid #4a6fa5;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #7B9FBE;
    }
    
    .form-group textarea {
        min-height: 60px;
        resize: vertical;
    }
    
    .time-input-group {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 0.5rem;
    }
    
    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }
    
    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #3d5a80 0%, #2c4662 100%);
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease;
        position: relative;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #4a6fa5;
    }
    
    .modal-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #e8f4f8;
        margin: 0;
    }
    
    .modal-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #e8f4f8;
        font-size: 1.5rem;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    
    .modal-body {
        color: #e8f4f8;
    }
    
    .modal-info-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.8rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .modal-label {
        font-weight: bold;
        color: #7B9FBE;
        min-width: 80px;
    }
    
    .modal-value {
        color: #e8f4f8;
        flex: 1;
    }
    
    .modal-badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
        background: linear-gradient(135deg, #7B9FBE 0%, #5A7FA0 100%);
        color: white;
    }
    
    .modal-badge.category-work { background: linear-gradient(135deg, #7B9FBE 0%, #5A7FA0 100%); }
    .modal-badge.category-personal { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .modal-badge.category-health { background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); }
    .modal-badge.category-learning { background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%); }
    .modal-badge.category-social { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
    
    .modal-actions {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #4a6fa5;
        display: flex;
        gap: 1rem;
        flex-direction: column;
    }
    
    .modal-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn-delete {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }
    
    .btn-delete-all {
        background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);
        color: white;
    }
    
    /* Confirmation Modal */
    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 2000;
        animation: fadeIn 0.2s ease;
    }
    
    .confirm-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .confirm-content {
        background: linear-gradient(135deg, #3d5a80 0%, #2c4662 100%);
        border-radius: 20px;
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
        animation: slideUp 0.3s ease;
        text-align: center;
    }
    
    .confirm-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .confirm-title {
        font-size: 1.4rem;
        font-weight: bold;
        color: #e8f4f8;
        margin-bottom: 1rem;
    }
    
    .confirm-message {
        color: #b8d4e8;
        font-size: 1rem;
        margin-bottom: 2rem;
        line-height: 1.5;
    }
    
    .confirm-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }
    
    .confirm-btn {
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }
    
    .confirm-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .confirm-btn-yes {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }
    
    .confirm-btn-no {
        background: rgba(255, 255, 255, 0.1);
        color: #e8f4f8;
        border: 2px solid #4a6fa5;
    }
    
    .confirm-btn-no:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media (max-width: 1024px) {
        .planner-grid {
            grid-template-columns: 1fr;
        }
        
        .calendar-grid {
            grid-template-columns: 60px repeat(7, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="hero-section">
    <h1>üìÖ Time Block Calendar</h1>
    <p>Plan your month with recurring time blocks - set it once, repeat forever</p>
</div>

<div class="planner-container">
    <div class="planner-header">
        <div class="view-toggle">
            <button class="view-btn active" id="weeklyViewBtn" onclick="switchView('weekly')">üìÖ Weekly</button>
            <button class="view-btn" id="monthlyViewBtn" onclick="switchView('monthly')">üìÜ Monthly</button>
            <button class="view-btn" onclick="goToToday()">‚≠ê Today</button>
        </div>
        
        <div class="date-navigation">
            <button class="date-nav-btn" onclick="changeDate(-1)">‚óÄ</button>
            <div class="current-date" id="currentDate">{{ month_name }}</div>
            <button class="date-nav-btn" onclick="changeDate(1)">‚ñ∂</button>
        </div>
    </div>

    <div class="planner-grid" id="plannerGrid">
        <!-- Weekly Calendar View -->
        <div class="weekly-container active" id="weeklyView">
            <!-- Weekly Stats Panel -->
            <div class="weekly-stats-panel">
                <div class="category-breakdown">
                    <div class="stats-header">Time Breakdown This Week</div>
                    <div id="categoryStats">
                        <!-- Category stats will be populated by JS -->
                    </div>
                </div>
                <div class="today-panel">
                    <h4>Today's Schedule</h4>
                    <div id="todayBlocksList" class="today-blocks-list">
                        <!-- Today's blocks will be populated by JS -->
                    </div>
                </div>
            </div>
            
            <div class="weekly-grid" id="weeklyGrid">
                <!-- Day columns will be generated by JavaScript -->
            </div>
        </div>

        <!-- Monthly Calendar View -->
        <div class="calendar-container" id="monthlyView" style="display: none;">
            <div class="calendar-header">
                {% for day in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                <div class="day-header">{{ day }}</div>
                {% endfor %}
            </div>
            
            <div class="calendar-days">
                {% for day_info in calendar_days %}
                <div class="day-cell {{ 'other-month' if not day_info.current_month else '' }} {{ 'today' if day_info.date == today else '' }}"
                     data-date="{{ day_info.date }}"
                     onclick="selectDay(this)">
                    <div class="day-number">{{ day_info.day }}</div>
                    <div class="day-blocks">
                        {% for block in blocks if block.date == day_info.date %}
                        <div class="calendar-block category-{{ block.category }}" 
                             data-block-id="{{ loop.index0 }}"
                             data-title="{{ block.title }}"
                             data-start="{{ block.start_time }}"
                             data-end="{{ block.end_time }}"
                             data-category="{{ block.category }}"
                             data-notes="{{ block.notes }}"
                             data-recurring="{{ 'true' if block.recurring else 'false' }}"
                             onclick="event.stopPropagation(); viewBlock(this)"
                             title="{{ block.title }} ({{ block.start_time }}-{{ block.end_time }})">
                            <div class="block-time">{{ block.start_time }}</div>
                            <div class="block-title-text">{{ block.title }}</div>
                            {% if block.recurring %}<span class="block-recurring-icon">üîÅ</span>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Add/Edit Block Form -->
        <div class="sidebar-container">
            <h3 class="sidebar-title">üìù Add Time Block</h3>
            <form method="POST" action="{{ url_for('productivity.add_time_block') }}" id="blockForm">
                <input type="hidden" name="date" id="blockDate">
                
                <div class="form-group">
                    <label for="title">Block Title</label>
                    <input type="text" id="title" name="title" required 
                           placeholder="e.g., Study, Walk, Meeting">
                </div>
                
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category" required>
                        <option value="">Select category</option>
                        <option value="work">üíº Work</option>
                        <option value="personal">üè† Personal</option>
                        <option value="health">üèÉ Health & Fitness</option>
                        <option value="learning">üìö Learning</option>
                        <option value="social">üë• Social</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Start Time</label>
                    <div class="time-input-group">
                        <select id="start_hour" name="start_hour" required>
                            <option value="">Hour</option>
                            {% for hour in range(1, 13) %}
                            <option value="{{ hour }}">{{ hour }}</option>
                            {% endfor %}
                        </select>
                        <select id="start_minute" name="start_minute" required>
                            <option value="00">00</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                        <select id="start_period" name="start_period" required>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>End Time</label>
                    <div class="time-input-group">
                        <select id="end_hour" name="end_hour" required>
                            <option value="">Hour</option>
                            {% for hour in range(1, 13) %}
                            <option value="{{ hour }}">{{ hour }}</option>
                            {% endfor %}
                        </select>
                        <select id="end_minute" name="end_minute" required>
                            <option value="00">00</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                        <select id="end_period" name="end_period" required>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes (optional)</label>
                    <textarea id="notes" name="notes" 
                              placeholder="Any specific goals or reminders?"></textarea>
                </div>
                
                <!-- Recurring Block Options -->
                <div class="recurring-toggle">
                    <label>
                        <input type="checkbox" id="isRecurring" name="recurring" value="true" onchange="toggleRecurringOptions()">
                        üîÅ Make this a recurring block
                    </label>
                </div>
                
                <div id="recurringOptions" class="recurring-options" style="display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #666;">
                        Repeat on:
                    </label>
                    <div class="days-selector">
                        <button type="button" class="day-btn" data-day="0" onclick="toggleDay(this)">Sun</button>
                        <button type="button" class="day-btn" data-day="1" onclick="toggleDay(this)">Mon</button>
                        <button type="button" class="day-btn" data-day="2" onclick="toggleDay(this)">Tue</button>
                        <button type="button" class="day-btn" data-day="3" onclick="toggleDay(this)">Wed</button>
                        <button type="button" class="day-btn" data-day="4" onclick="toggleDay(this)">Thu</button>
                        <button type="button" class="day-btn" data-day="5" onclick="toggleDay(this)">Fri</button>
                        <button type="button" class="day-btn" data-day="6" onclick="toggleDay(this)">Sat</button>
                    </div>
                    <input type="hidden" id="recurringDays" name="recurring_days" value="">
                </div>
                
                <button type="submit" class="btn-action btn-primary" style="width: 100%; margin-top: 1rem;">
                    Add Block
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Time Block Details Modal -->
<div class="modal-overlay" id="blockModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Time Block Details</h3>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="modal-info-row">
                <span class="modal-label">üìã Title:</span>
                <span class="modal-value" id="modalBlockTitle"></span>
            </div>
            <div class="modal-info-row">
                <span class="modal-label">üïí Time:</span>
                <span class="modal-value" id="modalTime"></span>
            </div>
            <div class="modal-info-row">
                <span class="modal-label">üìÅ Category:</span>
                <span class="modal-value"><span id="modalCategory" class="modal-badge"></span></span>
            </div>
            <div class="modal-info-row" id="modalRecurringRow" style="display: none;">
                <span class="modal-label">üîÅ Recurring:</span>
                <span class="modal-value">This block repeats</span>
            </div>
            <div class="modal-info-row" id="modalNotesRow" style="display: none;">
                <span class="modal-label">üìù Notes:</span>
                <span class="modal-value" id="modalNotes"></span>
            </div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn btn-delete" onclick="deleteBlock()">
                üóëÔ∏è Delete This Block
            </button>
            <button class="modal-btn btn-delete-all" id="deleteAllBtn" style="display: none;" onclick="deleteAllRecurring()">
                üóëÔ∏è Delete All Recurring Instances
            </button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
    <div class="confirm-content">
        <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
        <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
        <p class="confirm-message" id="confirmMessage">Are you sure?</p>
        <div class="confirm-buttons">
            <button class="confirm-btn confirm-btn-no" onclick="closeConfirm()">Cancel</button>
            <button class="confirm-btn confirm-btn-yes" id="confirmYesBtn">Delete</button>
        </div>
    </div>
</div>

<!-- Add Block Modal -->
<div class="modal-overlay" id="addBlockModal" onclick="closeAddBlockModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Add Time Block</h3>
            <button class="modal-close" onclick="closeAddBlockModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form method="POST" action="{{ url_for('productivity.add_time_block') }}" id="blockFormModal">
                <input type="hidden" name="date" id="blockDateModal">
                
                <div class="form-group">
                    <label for="titleModal">Block Title</label>
                    <input type="text" id="titleModal" name="title" required 
                           placeholder="e.g., Study, Walk, Meeting">
                </div>
                
                <div class="form-group">
                    <label for="categoryModal">Category</label>
                    <select id="categoryModal" name="category" required>
                        <option value="">Select category</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="health">Health & Fitness</option>
                        <option value="learning">Learning</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Start Time</label>
                    <div class="time-input-group">
                        <select id="start_hour_modal" name="start_hour" required>
                            <option value="">Hour</option>
                            {% for h in range(1, 13) %}
                            <option value="{{ h }}">{{ h }}</option>
                            {% endfor %}
                        </select>
                        <select id="start_minute_modal" name="start_minute" required>
                            <option value="00">00</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                        <select id="start_period_modal" name="start_period" required>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>End Time</label>
                    <div class="time-input-group">
                        <select id="end_hour_modal" name="end_hour" required>
                            <option value="">Hour</option>
                            {% for h in range(1, 13) %}
                            <option value="{{ h }}">{{ h }}</option>
                            {% endfor %}
                        </select>
                        <select id="end_minute_modal" name="end_minute" required>
                            <option value="00">00</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                        <select id="end_period_modal" name="end_period" required>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notesModal">Notes (optional)</label>
                    <textarea id="notesModal" name="notes" placeholder="Add any notes or reminders..."></textarea>
                </div>
                
                <div class="recurring-toggle">
                    <label>
                        <input type="checkbox" id="isRecurringModal" name="recurring" value="true" onchange="toggleRecurringOptionsModal()">
                        Repeat this block weekly
                    </label>
                </div>
                
                <div class="recurring-options" id="recurringOptionsModal" style="display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #e8f4f8;">Repeat on:</label>
                    <div class="days-selector">
                        <button type="button" class="day-btn" data-day="0" onclick="toggleDayModal(this)">Sun</button>
                        <button type="button" class="day-btn" data-day="1" onclick="toggleDayModal(this)">Mon</button>
                        <button type="button" class="day-btn" data-day="2" onclick="toggleDayModal(this)">Tue</button>
                        <button type="button" class="day-btn" data-day="3" onclick="toggleDayModal(this)">Wed</button>
                        <button type="button" class="day-btn" data-day="4" onclick="toggleDayModal(this)">Thu</button>
                        <button type="button" class="day-btn" data-day="5" onclick="toggleDayModal(this)">Fri</button>
                        <button type="button" class="day-btn" data-day="6" onclick="toggleDayModal(this)">Sat</button>
                    </div>
                    <input type="hidden" id="recurringDaysModal" name="recurring_days" value="">
                </div>
                
                <button type="submit" class="btn-action btn-primary" style="width: 100%; margin-top: 1.5rem;">
                    Add Block
                </button>
            </form>
        </div>
    </div>
</div>

<script>
let currentMonth = new Date('{{ current_month }}');
let currentWeekStart = new Date();
currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay()); // Start of current week
let selectedDays = [];
let allBlocks = {{ blocks|tojson }};
let currentView = 'weekly'; // Default view

function switchView(view) {
    currentView = view;
    
    // Update button states
    document.getElementById('weeklyViewBtn').classList.toggle('active', view === 'weekly');
    document.getElementById('monthlyViewBtn').classList.toggle('active', view === 'monthly');
    
    // Toggle visibility
    document.getElementById('weeklyView').style.display = view === 'weekly' ? 'block' : 'none';
    document.getElementById('monthlyView').style.display = view === 'monthly' ? 'block' : 'none';
    
    // Toggle grid layout
    document.getElementById('plannerGrid').classList.toggle('monthly-view', view === 'monthly');
    
    // Update navigation text
    if (view === 'weekly') {
        updateWeeklyView();
    } else {
        updateCalendar();
    }
}

function changeDate(direction) {
    if (currentView === 'weekly') {
        currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
        updateWeeklyView();
    } else {
        currentMonth.setMonth(currentMonth.getMonth() + direction);
        updateCalendar();
    }
}

function goToToday() {
    const today = new Date();
    if (currentView === 'weekly') {
        currentWeekStart = new Date(today);
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
        updateWeeklyView();
    } else {
        currentMonth = new Date(today);
        updateCalendar();
    }
}

function updateWeeklyView() {
    const weekDates = [];
    const today = new Date().toISOString().split('T')[0];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    // Get all 7 days of the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        weekDates.push(date.toISOString().split('T')[0]);
    }
    
    // Update header text
    const startDate = new Date(currentWeekStart);
    const endDate = new Date(currentWeekStart);
    endDate.setDate(endDate.getDate() + 6);
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    document.getElementById('currentDate').textContent = 
        monthNames[startDate.getMonth()] + ' ' + startDate.getDate() + ' - ' + 
        monthNames[endDate.getMonth()] + ' ' + endDate.getDate() + ', ' + endDate.getFullYear();
    
    // Generate day columns
    const container = document.getElementById('weeklyGrid');
    container.innerHTML = '';
    
    weekDates.forEach((dateStr, dayIndex) => {
        // Create day column
        const dayColumn = document.createElement('div');
        dayColumn.className = 'day-column';
        
        // Day header
        const date = new Date(dateStr);
        const dayHeader = document.createElement('div');
        dayHeader.className = 'weekly-day-header';
        if (dateStr === today) dayHeader.classList.add('today');
        dayHeader.innerHTML = dayNames[date.getDay()] + '<br><small>' + date.getDate() + '</small>';
        dayColumn.appendChild(dayHeader);
        
        // Add block button
        const addBtn = document.createElement('button');
        addBtn.className = 'add-block-btn';
        addBtn.innerHTML = '+ Add Block';
        addBtn.onclick = function(e) {
            e.stopPropagation();
            quickAddBlock(dateStr);
        };
        dayColumn.appendChild(addBtn);
        
        // Blocks container
        const blocksContainer = document.createElement('div');
        blocksContainer.className = 'day-column-blocks';
        blocksContainer.dataset.date = dateStr;
        
        // Drag and drop handlers
        blocksContainer.ondragover = function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            dayColumn.classList.add('drag-over');
        };
        
        blocksContainer.ondragleave = function(e) {
            if (e.target === blocksContainer) {
                dayColumn.classList.remove('drag-over');
            }
        };
        
        blocksContainer.ondrop = function(e) {
            e.preventDefault();
            dayColumn.classList.remove('drag-over');
            const blockId = e.dataTransfer.getData('blockId');
            if (blockId) {
                moveBlockToDate(parseInt(blockId), dateStr);
            }
        };
        
        blocksContainer.onclick = function(e) {
            if (e.target === blocksContainer || e.target.classList.contains('empty-day-message')) {
                quickAddBlock(dateStr);
            }
        };
        
        // Get and sort blocks for this day
        const dayBlocks = [];
        allBlocks.forEach((block, index) => {
            if (block.date === dateStr) {
                dayBlocks.push({ block, index });
            }
        });
        
        // Sort by start time
        dayBlocks.sort((a, b) => {
            return a.block.start_time.localeCompare(b.block.start_time);
        });
        
        // Add blocks to container
        if (dayBlocks.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'empty-day-message';
            emptyMsg.innerHTML = 'No blocks scheduled<br><small style="opacity: 0.7;">Click to add</small>';
            blocksContainer.appendChild(emptyMsg);
        } else {
            dayBlocks.forEach(({ block, index }) => {
                const blockDiv = createBlockElement(block, index);
                blocksContainer.appendChild(blockDiv);
            });
        }
        
        dayColumn.appendChild(blocksContainer);
        container.appendChild(dayColumn);
    });
    
    updateWeeklyStats();
}

function updateWeeklyStats() {
    const weekDates = [];
    const today = new Date().toISOString().split('T')[0];
    
    // Get all 7 days of the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        weekDates.push(date.toISOString().split('T')[0]);
    }
    
    // Calculate category totals
    const categoryTotals = {
        work: 0,
        personal: 0,
        health: 0,
        learning: 0,
        social: 0
    };
    
    const categoryLabels = {
        work: 'Work',
        personal: 'Personal',
        health: 'Health & Fitness',
        learning: 'Learning',
        social: 'Social'
    };
    
    let totalMinutes = 0;
    let todayBlocks = [];
    
    allBlocks.forEach(block => {
        if (weekDates.includes(block.date)) {
            // Calculate duration
            const startParts = block.start_time.split(':');
            const endParts = block.end_time.split(':');
            const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
            const duration = endMinutes - startMinutes;
            
            if (duration > 0 && categoryTotals.hasOwnProperty(block.category)) {
                categoryTotals[block.category] += duration;
                totalMinutes += duration;
            }
            
            // Collect today's blocks
            if (block.date === today) {
                todayBlocks.push(block);
            }
        }
    });
    
    // Update category stats
    const statsContainer = document.getElementById('categoryStats');
    statsContainer.innerHTML = '';
    
    Object.keys(categoryTotals).forEach(category => {
        const minutes = categoryTotals[category];
        if (minutes > 0) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
            const percentage = totalMinutes > 0 ? (minutes / totalMinutes) * 100 : 0;
            
            const statDiv = document.createElement('div');
            statDiv.className = 'category-stat';
            statDiv.innerHTML = `
                <div class="category-info">
                    <div class="category-color ${category}"></div>
                    <span class="category-name">${categoryLabels[category]}</span>
                    <div class="category-bar">
                        <div class="category-bar-fill ${category}" style="width: ${percentage}%"></div>
                    </div>
                </div>
                <span class="category-time">${timeStr}</span>
            `;
            statsContainer.appendChild(statDiv);
        }
    });
    
    if (totalMinutes === 0) {
        statsContainer.innerHTML = '<div style="color: #7B9FBE; opacity: 0.6; text-align: center; padding: 1rem;">No blocks scheduled this week</div>';
    }
    
    // Update today's blocks
    const todayList = document.getElementById('todayBlocksList');
    todayList.innerHTML = '';
    
    if (todayBlocks.length === 0) {
        todayList.innerHTML = '<div class="today-empty">No blocks for today</div>';
    } else {
        // Sort by start time
        todayBlocks.sort((a, b) => a.start_time.localeCompare(b.start_time));
        
        todayBlocks.forEach(block => {
            const blockItem = document.createElement('div');
            blockItem.className = `today-block-item ${block.category}`;
            
            // Format times to ensure proper 24-hour display
            const formatTime24 = (timeStr) => {
                const parts = timeStr.split(':');
                const hours = parseInt(parts[0]).toString().padStart(2, '0');
                const minutes = parts[1].padStart(2, '0');
                return `${hours}:${minutes}`;
            };
            
            blockItem.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.2rem;">${block.title}</div>
                <div style="opacity: 0.8; font-size: 0.75rem;">${formatTime24(block.start_time)} - ${formatTime24(block.end_time)}</div>
            `;
            todayList.appendChild(blockItem);
        });
        
        const totalMins = todayBlocks.reduce((sum, block) => {
            const startParts = block.start_time.split(':');
            const endParts = block.end_time.split(':');
            const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
            return sum + (endMinutes - startMinutes);
        }, 0);
        
        const totalHours = Math.floor(totalMins / 60);
        const totalMinutesRem = totalMins % 60;
        const totalStr = totalHours > 0 ? `${totalHours}h ${totalMinutesRem}m` : `${totalMinutesRem}m`;
        
        const totalDiv = document.createElement('div');
        totalDiv.className = 'today-total';
        totalDiv.textContent = `Total: ${totalStr} scheduled`;
        todayList.appendChild(totalDiv);
    }
}

function createBlockElement(block, index) {
    const blockDiv = document.createElement('div');
    blockDiv.className = 'calendar-block category-' + block.category;
    blockDiv.dataset.blockId = index;
    blockDiv.dataset.title = block.title;
    blockDiv.dataset.start = block.start_time;
    blockDiv.dataset.end = block.end_time;
    blockDiv.dataset.category = block.category;
    blockDiv.dataset.notes = block.notes || '';
    blockDiv.dataset.recurring = block.recurring ? 'true' : 'false';
    blockDiv.setAttribute('title', block.title + ' (' + block.start_time + '-' + block.end_time + ')');
    blockDiv.setAttribute('draggable', 'true');
    
    // Drag events
    blockDiv.ondragstart = function(e) {
        e.dataTransfer.setData('blockId', index);
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => blockDiv.classList.add('dragging'), 0);
    };
    
    blockDiv.ondragend = function(e) {
        blockDiv.classList.remove('dragging');
    };
    
    blockDiv.onclick = function(e) {
        e.stopPropagation();
        viewBlock(this);
    };
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'block-time';
    timeDiv.textContent = block.start_time;
    
    const titleDiv = document.createElement('div');
    titleDiv.className = 'block-title-text';
    titleDiv.textContent = block.title;
    
    blockDiv.appendChild(timeDiv);
    blockDiv.appendChild(titleDiv);
    
    if (block.recurring) {
        const recurIcon = document.createElement('span');
        recurIcon.className = 'block-recurring-icon';
        recurIcon.textContent = 'üîÅ';
        blockDiv.appendChild(recurIcon);
    }
    
    return blockDiv;
}

function moveBlockToDate(blockId, newDate) {
    const block = allBlocks[blockId];
    if (!block) return;
    
    // Convert 24-hour time to 12-hour format for backend
    const convert24to12 = (time24) => {
        const [hourStr, minute] = time24.split(':');
        let hour = parseInt(hourStr);
        const period = hour >= 12 ? 'PM' : 'AM';
        
        if (hour === 0) {
            hour = 12; // Midnight
        } else if (hour > 12) {
            hour = hour - 12; // Convert to 12-hour
        }
        
        return { hour: hour.toString(), minute, period };
    };
    
    const startTime = convert24to12(block.start_time);
    const endTime = convert24to12(block.end_time);
    
    // Update the block's date
    fetch('{{ url_for("productivity.add_time_block") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'block_id': blockId,
            'date': newDate,
            'title': block.title,
            'category': block.category,
            'start_hour': startTime.hour,
            'start_minute': startTime.minute,
            'start_period': startTime.period,
            'end_hour': endTime.hour,
            'end_minute': endTime.minute,
            'end_period': endTime.period,
            'notes': block.notes || '',
            'recurring': block.recurring || false,
            'recurring_days': block.recurring_days || ''
        })
    }).then(response => {
        if (response.ok) {
            // Update local data
            allBlocks[blockId].date = newDate;
            
            // Refresh view
            if (currentView === 'weekly') {
                updateWeeklyView();
            } else {
                updateCalendar();
            }
        }
    });
}

function quickAddBlock(date) {
    if (currentView === 'weekly') {
        // Open modal for weekly view
        document.getElementById('blockDateModal').value = date;
        const now = new Date();
        const hour = now.getHours();
        document.getElementById('start_hour_modal').value = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        document.getElementById('start_minute_modal').value = '00';
        document.getElementById('start_period_modal').value = hour >= 12 ? 'PM' : 'AM';
        document.getElementById('addBlockModal').classList.add('active');
        setTimeout(() => document.getElementById('titleModal').focus(), 100);
    } else {
        // Use sidebar form for monthly view
        document.getElementById('blockDate').value = date;
        const now = new Date();
        const hour = now.getHours();
        document.getElementById('start_hour').value = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        document.getElementById('start_minute').value = '00';
        document.getElementById('start_period').value = hour >= 12 ? 'PM' : 'AM';
        document.getElementById('title').focus();
    }
}

function closeAddBlockModal(event) {
    if (!event || event.target.id === 'addBlockModal') {
        document.getElementById('addBlockModal').classList.remove('active');
        document.getElementById('blockFormModal').reset();
    }
}

function toggleRecurringOptionsModal() {
    const checkbox = document.getElementById('isRecurringModal');
    const options = document.getElementById('recurringOptionsModal');
    options.style.display = checkbox.checked ? 'block' : 'none';
}

let selectedDaysModal = [];

function toggleDayModal(button) {
    button.classList.toggle('selected');
    const day = button.getAttribute('data-day');
    
    if (button.classList.contains('selected')) {
        if (!selectedDaysModal.includes(day)) {
            selectedDaysModal.push(day);
        }
    } else {
        selectedDaysModal = selectedDaysModal.filter(d => d !== day);
    }
    
    document.getElementById('recurringDaysModal').value = selectedDaysModal.join(',');
}

function changeMonth(months) {
    currentMonth.setMonth(currentMonth.getMonth() + months);
    updateCalendar();
}

function updateCalendar() {
    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    const monthName = monthNames[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
    document.getElementById('currentMonth').textContent = monthName;
    
    // Generate calendar days
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarDays = [];
    const today = new Date().toISOString().split('T')[0];
    
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const isCurrentMonth = date.getMonth() === month;
        const isToday = dateStr === today;
        
        calendarDays.push({
            date: dateStr,
            day: date.getDate(),
            currentMonth: isCurrentMonth,
            today: isToday
        });
    }
    
    // Regenerate calendar grid
    const calendarGrid = document.querySelector('.calendar-days');
    calendarGrid.innerHTML = '';
    
    calendarDays.forEach(dayInfo => {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell';
        if (!dayInfo.currentMonth) dayCell.classList.add('other-month');
        if (dayInfo.today) dayCell.classList.add('today');
        dayCell.setAttribute('data-date', dayInfo.date);
        dayCell.onclick = function() { selectDay(this); };
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = dayInfo.day;
        
        const dayBlocks = document.createElement('div');
        dayBlocks.className = 'day-blocks';
        
        // Add blocks for this date
        allBlocks.forEach((block, index) => {
            if (block.date === dayInfo.date) {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'calendar-block category-' + block.category;
                blockDiv.setAttribute('data-block-id', index);
                blockDiv.setAttribute('data-title', block.title);
                blockDiv.setAttribute('data-start', block.start_time);
                blockDiv.setAttribute('data-end', block.end_time);
                blockDiv.setAttribute('data-category', block.category);
                blockDiv.setAttribute('data-notes', block.notes || '');
                blockDiv.setAttribute('data-recurring', block.recurring ? 'true' : 'false');
                blockDiv.setAttribute('title', block.title + ' (' + block.start_time + '-' + block.end_time + ')');
                blockDiv.onclick = function(e) {
                    e.stopPropagation();
                    viewBlock(this);
                };
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'block-time';
                timeDiv.textContent = block.start_time;
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'block-title-text';
                titleDiv.textContent = block.title;
                
                blockDiv.appendChild(timeDiv);
                blockDiv.appendChild(titleDiv);
                
                if (block.recurring) {
                    const recurIcon = document.createElement('span');
                    recurIcon.className = 'block-recurring-icon';
                    recurIcon.textContent = 'üîÅ';
                    blockDiv.appendChild(recurIcon);
                }
                
                dayBlocks.appendChild(blockDiv);
            }
        });
        
        dayCell.appendChild(dayNumber);
        dayCell.appendChild(dayBlocks);
        calendarGrid.appendChild(dayCell);
    });
}

function selectDay(cell) {
    // Remove previous selection
    const previousSelected = document.querySelector('.day-cell.selected');
    if (previousSelected) {
        previousSelected.classList.remove('selected');
    }
    
    // Add selected class to clicked cell
    cell.classList.add('selected');
    
    const date = cell.getAttribute('data-date');
    document.getElementById('blockDate').value = date;
    document.getElementById('title').focus();
}

function viewBlock(element) {
    const title = element.dataset.title;
    const startTime = element.dataset.start;
    const endTime = element.dataset.end;
    const category = element.dataset.category;
    const notes = element.dataset.notes;
    const recurring = element.dataset.recurring === 'true';
    const blockId = element.dataset.blockId;
    
    // Store block ID for delete operations
    document.getElementById('blockModal').dataset.blockId = blockId;
    document.getElementById('blockModal').dataset.blockTitle = title;
    
    // Populate modal
    document.getElementById('modalBlockTitle').textContent = title;
    document.getElementById('modalTime').textContent = startTime + ' - ' + endTime;
    
    const categoryBadge = document.getElementById('modalCategory');
    categoryBadge.textContent = category.charAt(0).toUpperCase() + category.slice(1);
    categoryBadge.className = 'modal-badge category-' + category;
    
    // Show/hide recurring indicator and delete all button
    document.getElementById('modalRecurringRow').style.display = recurring ? 'flex' : 'none';
    document.getElementById('deleteAllBtn').style.display = recurring ? 'block' : 'none';
    
    // Show/hide notes
    if (notes && notes.trim() !== '') {
        document.getElementById('modalNotes').textContent = notes;
        document.getElementById('modalNotesRow').style.display = 'flex';
    } else {
        document.getElementById('modalNotesRow').style.display = 'none';
    }
    
    // Show modal
    document.getElementById('blockModal').classList.add('active');
}

function closeModal(event) {
    // Close if clicking overlay or close button (not when event is undefined)
    if (!event || event.target.id === 'blockModal' || event.target.classList.contains('modal-close')) {
        document.getElementById('blockModal').classList.remove('active');
    }
}

function deleteBlock() {
    const modal = document.getElementById('blockModal');
    const blockTitle = modal.dataset.blockTitle;
    const blockId = modal.dataset.blockId;
    
    // Show custom confirmation
    showConfirm(
        'üóëÔ∏è',
        'Delete Time Block?',
        'Are you sure you want to delete "' + blockTitle + '"?',
        function() {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("productivity.delete_time_block") }}';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'block_id';
            input.value = blockId;
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    );
}

function deleteAllRecurring() {
    const modal = document.getElementById('blockModal');
    const blockTitle = modal.dataset.blockTitle;
    const blockId = modal.dataset.blockId;
    
    // Show custom confirmation
    showConfirm(
        'üîÅ',
        'Delete All Recurring Blocks?',
        'This will delete ALL recurring instances of "' + blockTitle + '". This action cannot be undone.',
        function() {
            // Create form and submit with delete_all flag
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("productivity.delete_time_block") }}';
            
            const inputId = document.createElement('input');
            inputId.type = 'hidden';
            inputId.name = 'block_id';
            inputId.value = blockId;
            
            const inputAll = document.createElement('input');
            inputAll.type = 'hidden';
            inputAll.name = 'delete_all';
            inputAll.value = 'true';
            
            form.appendChild(inputId);
            form.appendChild(inputAll);
            document.body.appendChild(form);
            form.submit();
        }
    );
}

function showConfirm(icon, title, message, onConfirm) {
    document.getElementById('confirmIcon').textContent = icon;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    
    // Set up the confirm button
    const yesBtn = document.getElementById('confirmYesBtn');
    yesBtn.onclick = function() {
        closeConfirm();
        onConfirm();
    };
    
    // Show modal
    document.getElementById('confirmModal').classList.add('active');
}

function closeConfirm() {
    document.getElementById('confirmModal').classList.remove('active');
}

function toggleRecurringOptions() {
    const checkbox = document.getElementById('isRecurring');
    const options = document.getElementById('recurringOptions');
    options.style.display = checkbox.checked ? 'block' : 'none';
}

function toggleDay(button) {
    button.classList.toggle('selected');
    const day = button.getAttribute('data-day');
    
    if (button.classList.contains('selected')) {
        if (!selectedDays.includes(day)) {
            selectedDays.push(day);
        }
    } else {
        selectedDays = selectedDays.filter(function(d) { return d !== day; });
    }
    
    document.getElementById('recurringDays').value = selectedDays.join(',');
}

// Auto-calculate end time when start time changes
document.addEventListener('DOMContentLoaded', function() {
    // Auto-fill end time when start time is selected
    const startHour = document.getElementById('start_hour');
    const startMinute = document.getElementById('start_minute');
    const startPeriod = document.getElementById('start_period');
    
    function updateEndTime() {
        if (startHour.value && startMinute.value && startPeriod.value) {
            const endHour = document.getElementById('end_hour');
            const endMinute = document.getElementById('end_minute');
            const endPeriod = document.getElementById('end_period');
            
            // Only auto-fill if end time is empty
            if (!endHour.value) {
                let hour = parseInt(startHour.value);
                const minute = startMinute.value;
                let period = startPeriod.value;
                
                // Add 1 hour
                hour += 1;
                if (hour === 13) {
                    hour = 1;
                } else if (hour === 12 && startHour.value === '11') {
                    period = period === 'AM' ? 'PM' : 'AM';
                }
                
                endHour.value = hour;
                endMinute.value = minute;
                endPeriod.value = period;
            }
        }
    }
    
    startHour.addEventListener('change', updateEndTime);
    startMinute.addEventListener('change', updateEndTime);
    startPeriod.addEventListener('change', updateEndTime);
    
    // Initialize weekly view
    updateWeeklyView();
});
</script>
{% endblock %}
