{% extends "base.html" %}

{% block title %}Pomodoro Timer - jamOS{% endblock %}

{% block content %}
<div class="hero-section">
    <h1>üçÖ Pomodoro Timer</h1>
    <p>Stay focused with the Pomodoro Technique</p>
</div>

<div class="timer-container">
    <div class="timer-modes">
        <button class="mode-btn active" data-mode="work" data-duration="25">Work (25m)</button>
        <button class="mode-btn" data-mode="shortBreak" data-duration="5">Short Break (5m)</button>
        <button class="mode-btn" data-mode="longBreak" data-duration="15">Long Break (15m)</button>
    </div>
    
    <div class="circular-timer">
        <div class="timer-ring">
            <svg class="progress-ring" width="300" height="300">
                <defs>
                    <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#7B9FBE;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#5A7FA0;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle class="bg-ring" cx="150" cy="150" r="130" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="10"></circle>
                <circle class="progress-ring-fill" id="progressRing" cx="150" cy="150" r="130" 
                        fill="none" stroke="url(#timerGradient)" stroke-width="10" 
                        stroke-linecap="round" stroke-dasharray="816.8" stroke-dashoffset="816.8"
                        transform="rotate(-90 150 150)"></circle>
            </svg>
        </div>
        
        <div class="timer-center">
            <img src="{{ url_for('static', filename='images/idle.gif') }}" 
                 alt="Oshawott" class="oshawott-gif" id="oshaGif">
        </div>
    </div>
    
    <div class="timer-display" id="timerDisplay">25:00</div>
    
    <div class="timer-controls">
        <button class="timer-btn primary" id="startBtn">Start</button>
        <button class="timer-btn secondary" id="pauseBtn">Pause</button>
        <button class="timer-btn danger" id="resetBtn">Reset</button>
    </div>
    
    <div class="motivation" id="motivation">
        Ready to focus? Let's make this session count! üí™
    </div>
    
    <div class="stats-container">
        <div class="stat-item">
            <span class="stat-number" id="completedSessions">0</span>
            <span class="stat-label">Completed Today</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="totalMinutes">0</span>
            <span class="stat-label">Minutes Focused</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="currentStreak">0</span>
            <span class="stat-label">Current Streak</span>
        </div>
    </div>
</div>

<script>
class PomodoroTimer {
    constructor() {
        this.timeLeft = 25 * 60; // 25 minutes in seconds
        this.isRunning = false;
        this.hasStarted = false;
        this.currentMode = 'work';
        this.timer = null;
        this.completedSessions = parseInt(localStorage.getItem('pomodoroCompleted') || '0');
        this.totalMinutes = parseInt(localStorage.getItem('pomodoroMinutes') || '0');
        this.currentStreak = parseInt(localStorage.getItem('pomodoroStreak') || '0');
        
        this.initElements();
        this.initEventListeners();
        this.updateDisplay();
        this.updateStats();
        this.showMotivationalMessage();
    }
    
    initElements() {
        this.display = document.getElementById('timerDisplay');
        this.startBtn = document.getElementById('startBtn');
        this.pauseBtn = document.getElementById('pauseBtn');
        this.resetBtn = document.getElementById('resetBtn');
        this.motivation = document.getElementById('motivation');
        this.oshaGif = document.getElementById('oshaGif');
        this.modeButtons = document.querySelectorAll('.mode-btn');
        this.progressRing = document.getElementById('progressRing');
    }
    
    updateGif() {
        const basePath = "{{ url_for('static', filename='images/') }}";
        if (!this.hasStarted) {
            this.oshaGif.src = basePath + 'idle.gif';
        } else if (this.currentMode === 'work') {
            this.oshaGif.src = basePath + 'active.gif';
        } else {
            this.oshaGif.src = basePath + 'break-time.gif';
        }
    }
    
    initEventListeners() {
        this.startBtn.addEventListener('click', () => this.start());
        this.pauseBtn.addEventListener('click', () => this.pause());
        this.resetBtn.addEventListener('click', () => this.reset());
        
        this.modeButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchMode(e.target.dataset.mode, parseInt(e.target.dataset.duration));
            });
        });
    }
    
    start() {
        if (!this.isRunning) {
            this.isRunning = true;
            this.hasStarted = true;
            this.display.classList.add('running');
            this.timer = setInterval(() => this.tick(), 1000);
            this.startBtn.textContent = 'Running...';
            this.startBtn.disabled = true;
            this.pauseBtn.disabled = false;
            this.updateGif();
        }
    }
    
    pause() {
        if (this.isRunning) {
            this.isRunning = false;
            this.display.classList.remove('running');
            clearInterval(this.timer);
            this.startBtn.textContent = 'Resume';
            this.startBtn.disabled = false;
            this.pauseBtn.disabled = true;
        }
    }
    
    reset() {
        this.pause();
        this.hasStarted = false;
        const activeMode = document.querySelector('.mode-btn.active');
        this.timeLeft = parseInt(activeMode.dataset.duration) * 60;
        this.updateDisplay();
        this.startBtn.textContent = 'Start';
        this.startBtn.disabled = false;
        this.pauseBtn.disabled = true;
        this.oshaGif.classList.remove('celebration');
        this.updateGif();
    }
    
    switchMode(mode, duration) {
        this.pause();
        this.hasStarted = false;
        this.currentMode = mode;
        this.timeLeft = duration * 60;
        
        // Update active mode button
        this.modeButtons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        this.updateDisplay();
        this.startBtn.textContent = 'Start';
        this.startBtn.disabled = false;
        this.pauseBtn.disabled = true;
        this.showMotivationalMessage();
        this.updateGif();
    }
    
    tick() {
        if (this.timeLeft > 0) {
            this.timeLeft--;
            this.updateDisplay();
        } else {
            this.complete();
        }
    }
    
    complete() {
        this.pause();
        this.playCompletionSound();
        this.oshaGif.classList.add('celebration');
        
        if (this.currentMode === 'work') {
            this.completedSessions++;
            this.totalMinutes += 25;
            this.currentStreak++;
            this.saveStats();
            this.updateStats();
            this.motivation.textContent = "üéâ Great work! Time for a well-deserved break!";
        } else {
            this.motivation.textContent = "‚òï Break's over! Ready to focus again?";
        }
        
        // Auto-switch to next mode
        setTimeout(() => {
            if (this.currentMode === 'work') {
                const nextMode = this.completedSessions % 4 === 0 ? 'longBreak' : 'shortBreak';
                const duration = nextMode === 'longBreak' ? 15 : 5;
                this.autoSwitchMode(nextMode, duration);
            } else {
                this.autoSwitchMode('work', 25);
            }
            this.oshaGif.classList.remove('celebration');
        }, 3000);
    }
    
    autoSwitchMode(mode, duration) {
        this.currentMode = mode;
        this.timeLeft = duration * 60;
        
        // Update active mode button
        this.modeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
        
        this.updateDisplay();
        this.startBtn.textContent = 'Start';
        this.startBtn.disabled = false;
        this.pauseBtn.disabled = true;
        this.showMotivationalMessage();
    }
    
    updateDisplay() {
        const minutes = Math.floor(this.timeLeft / 60);
        const seconds = this.timeLeft % 60;
        this.display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update circular progress
        const totalTime = this.currentMode === 'work' ? 25 * 60 : (this.currentMode === 'shortBreak' ? 5 * 60 : 15 * 60);
        const progress = (totalTime - this.timeLeft) / totalTime;
        const circumference = 2 * Math.PI * 130; // radius = 130
        const offset = circumference - (progress * circumference);
        this.progressRing.style.strokeDashoffset = offset;
    }
    
    updateStats() {
        document.getElementById('completedSessions').textContent = this.completedSessions;
        document.getElementById('totalMinutes').textContent = this.totalMinutes;
        document.getElementById('currentStreak').textContent = this.currentStreak;
    }
    
    saveStats() {
        localStorage.setItem('pomodoroCompleted', this.completedSessions.toString());
        localStorage.setItem('pomodoroMinutes', this.totalMinutes.toString());
        localStorage.setItem('pomodoroStreak', this.currentStreak.toString());
    }
    
    showMotivationalMessage() {
        const messages = {
            work: [
                "Ready to focus? Let's make this session count! üí™",
                "Time to dive deep and get things done! üöÄ",
                "Focus mode activated! You've got this! ‚ö°",
                "Let's turn this session into progress! üéØ",
                "Deep work time! Make every minute matter! üî•"
            ],
            shortBreak: [
                "Take a breather! You've earned it! üòå",
                "Quick break time - stretch and relax! üßò",
                "5 minutes to recharge your batteries! üîã",
                "Mini break mode: rest and reset! ‚òï"
            ],
            longBreak: [
                "Long break time! Go for a walk! üö∂",
                "15 minutes to fully recharge! üåü",
                "Extended break - treat yourself! üéâ",
                "Time for a proper break! You've earned it! üèÜ"
            ]
        };
        
        const modeMessages = messages[this.currentMode];
        const randomMessage = modeMessages[Math.floor(Math.random() * modeMessages.length)];
        this.motivation.textContent = randomMessage;
    }
    
    playCompletionSound() {
        // Simple audio notification
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(this.currentMode === 'work' ? 'Time for a break!' : 'Back to work!');
            utterance.rate = 0.8;
            utterance.pitch = 1.2;
            speechSynthesis.speak(utterance);
        }
    }
}

// Initialize timer when page loads
document.addEventListener('DOMContentLoaded', () => {
    new PomodoroTimer();
});
</script>
{% endblock %}
